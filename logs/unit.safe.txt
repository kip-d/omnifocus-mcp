
 RUN  v3.2.4 /Users/kip/codex/omnifocus-mcp

 ✓ tests/unit/omnifocus/OmniAutomation.test.ts (24 tests) 15ms
 ✓ tests/unit/tools/base.test.ts (30 tests) 60ms
 ❯ tests/unit/tools/analytics/workflow-analysis-tool.test.ts (4 tests | 2 failed) 17ms
   ✓ WorkflowAnalysisTool > returns cached results when available 4ms
   ✓ WorkflowAnalysisTool > handles script error result with structured error 2ms
   × WorkflowAnalysisTool > returns analytics response with key findings and optional raw data 8ms
     → expected false to be true // Object.is equality
   × WorkflowAnalysisTool > extractKeyFindings falls back to default message 1ms
     → expected false to be true // Object.is equality
 ✓ tests/unit/timezone.test.ts (31 tests) 175ms
 ❯ tests/unit/tools/project-crud.test.ts (14 tests | 5 failed) 20ms
   ✓ ProjectsToolV2 CRUD Operations > list operation > should list projects 4ms
   ✓ ProjectsToolV2 CRUD Operations > list operation > should use cached results when available 1ms
   × ProjectsToolV2 CRUD Operations > create operation > should create a simple project 6ms
     → expected false to be true // Object.is equality
   × ProjectsToolV2 CRUD Operations > create operation > should create a complex project with all options 1ms
     → expected false to be true // Object.is equality
   ✓ ProjectsToolV2 CRUD Operations > create operation > should validate required parameters 0ms
   × ProjectsToolV2 CRUD Operations > update operation > should update project properties 5ms
     → expected false to be true // Object.is equality
   ✓ ProjectsToolV2 CRUD Operations > update operation > should validate required parameters 0ms
   × ProjectsToolV2 CRUD Operations > complete operation > should complete a project 1ms
     → expected false to be true // Object.is equality
   × ProjectsToolV2 CRUD Operations > complete operation > should complete a project with all tasks 1ms
     → expected false to be true // Object.is equality
   ✓ ProjectsToolV2 CRUD Operations > delete operation > should delete a project 1ms
   ✓ ProjectsToolV2 CRUD Operations > delete operation > should handle permission denied and use URL scheme fallback 0ms
   ✓ ProjectsToolV2 CRUD Operations > error handling > should handle script execution errors 0ms
   ✓ ProjectsToolV2 CRUD Operations > error handling > should handle invalid operation 0ms
   ✓ ProjectsToolV2 CRUD Operations > tool metadata > should have correct name and description 0ms
 ✓ tests/unit/utils/response-format-utilities.test.ts (34 tests) 12ms
 ❯ tests/unit/tools/task-crud.test.ts (30 tests | 11 failed) 35ms
   × Task CRUD Operations > CreateTaskTool > successful operations > should create a simple task 7ms
     → expected "spy" to be called with arguments: [ 'test script' ][90m

Number of calls: [1m0[22m
[39m
   × Task CRUD Operations > CreateTaskTool > successful operations > should create a task with all optional fields 1ms
     → expected "spy" to be called 1 times, but got 0 times
   ✓ Task CRUD Operations > CreateTaskTool > successful operations > should handle object response from script 0ms
   ✓ Task CRUD Operations > CreateTaskTool > validation > should reject missing name 2ms
   ✓ Task CRUD Operations > CreateTaskTool > validation > should reject empty name 5ms
   ✓ Task CRUD Operations > CreateTaskTool > validation > should reject invalid date format 1ms
   ✓ Task CRUD Operations > CreateTaskTool > validation > should reject negative estimated minutes 1ms
   × Task CRUD Operations > CreateTaskTool > error handling > should handle script execution error 3ms
     → expected 'INTERNAL_ERROR' to be 'SCRIPT_ERROR' // Object.is equality
   ✓ Task CRUD Operations > CreateTaskTool > error handling > should handle permission denied error 1ms
   × Task CRUD Operations > UpdateTaskTool > successful operations > should update task name 2ms
     → expected "spy" to be called with arguments: [ Any<String>, …(1) ][90m

Number of calls: [1m0[22m
[39m
   × Task CRUD Operations > UpdateTaskTool > successful operations > should update multiple fields 1ms
     → expected false to be true // Object.is equality
   × Task CRUD Operations > UpdateTaskTool > successful operations > should clear due date when clearDueDate is true 0ms
     → expected false to be true // Object.is equality
   ✓ Task CRUD Operations > UpdateTaskTool > successful operations > should handle no updates provided 0ms
   ✓ Task CRUD Operations > UpdateTaskTool > validation > should reject missing taskId 0ms
   ✓ Task CRUD Operations > UpdateTaskTool > validation > should reject empty taskId 0ms
   ✓ Task CRUD Operations > UpdateTaskTool > validation > should reject invalid date format 0ms
   ✓ Task CRUD Operations > UpdateTaskTool > error handling > should handle script execution error 0ms
   × Task CRUD Operations > CompleteTaskTool > successful operations > should complete a task 1ms
     → expected false to be true // Object.is equality
   × Task CRUD Operations > CompleteTaskTool > successful operations > should complete a task with custom completion date 0ms
     → expected false to be true // Object.is equality
   ✓ Task CRUD Operations > CompleteTaskTool > successful operations > should fallback to URL scheme on access denied 1ms
   ✓ Task CRUD Operations > CompleteTaskTool > validation > should reject missing taskId 1ms
   ✓ Task CRUD Operations > CompleteTaskTool > validation > should reject invalid completion date 0ms
   × Task CRUD Operations > CompleteTaskTool > error handling > should handle script execution error 1ms
     → expected { code: 'SCRIPT_ERROR', …(2) } to be true // Object.is equality
   ✓ Task CRUD Operations > CompleteTaskTool > error handling > should handle permission error with exception 1ms
   × Task CRUD Operations > DeleteTaskTool > successful operations > should delete a task 1ms
     → expected false to be true // Object.is equality
   ✓ Task CRUD Operations > DeleteTaskTool > successful operations > should fallback to URL scheme on permission error 0ms
   ✓ Task CRUD Operations > DeleteTaskTool > successful operations > should handle exception-based permission error 0ms
   ✓ Task CRUD Operations > DeleteTaskTool > validation > should reject missing taskId 1ms
   ✓ Task CRUD Operations > DeleteTaskTool > validation > should reject empty taskId 1ms
   × Task CRUD Operations > DeleteTaskTool > error handling > should handle script execution error 0ms
     → expected { code: 'SCRIPT_ERROR', …(2) } to be true // Object.is equality
 ✓ tests/unit/tools/list-projects-tool.test.ts (9 tests) 13ms
 ✓ tests/unit/tools/perspectives-v2.test.ts (8 tests) 14ms
 ✓ tests/unit/code-changes-verification.test.ts (5 tests) 58ms
 ✓ tests/unit/tools/system-v2.test.ts (8 tests) 34ms
 ✓ tests/unit/tools/export.test.ts (32 tests) 35ms
 ❯ tests/unit/response-format-consistency.test.ts (11 tests | 1 failed) 24ms
   ✓ Response Format Consistency Tests > Standardized Response Structure > should verify all tool responses have consistent structure 5ms
   ✓ Response Format Consistency Tests > Standardized Response Structure > should ensure successful responses have required fields 2ms
   ✓ Response Format Consistency Tests > Standardized Response Structure > should ensure error responses have required fields 1ms
   ✓ Response Format Consistency Tests > Metadata Field Naming Consistency > should use snake_case for all metadata fields 1ms
   ✓ Response Format Consistency Tests > Cache Behavior Consistency > should set from_cache to true when returning cached data 1ms
   ✓ Response Format Consistency Tests > Cache Behavior Consistency > should set from_cache to false when fetching fresh data 1ms
   ✓ Response Format Consistency Tests > Export Tool Response Consistency > should have nested export structure for export tools 1ms
   ✓ Response Format Consistency Tests > Analytics Tool Response Consistency > should have proper stats structure for analytics tools 1ms
   ✓ Response Format Consistency Tests > Error Handling Consistency > should use handleError for all error cases 3ms
   × Response Format Consistency Tests > Error Handling Consistency > should include recovery suggestions for known errors 6ms
     → expected 'INTERNAL_ERROR' to be 'PERMISSION_DENIED' // Object.is equality
   ✓ Response Format Consistency Tests > Type Safety Verification > should have proper TypeScript return types (not any) 0ms
 ✓ tests/unit/utils/schema-validation.test.ts (35 tests) 4ms
 ✓ tests/unit/tools/tags-v2.test.ts (13 tests) 34ms
 ✓ tests/unit/omnifocus/RobustOmniAutomation.test.ts (14 tests) 14ms
 ✓ tests/unit/tools/tasks/query-tasks-upcoming.test.ts (3 tests) 8ms
 ✓ tests/unit/tools/recurring.test.ts (14 tests) 12ms
 ✓ tests/unit/completed-project-tasks.test.ts (11 tests) 10ms
 ✓ tests/unit/tools/analytics.test.ts (30 tests) 28ms
 ✓ tests/unit/tools/folders.test.ts (21 tests) 41ms
 ✓ tests/unit/tools/projects/ProjectsToolV2.test.ts (30 tests) 42ms
 ✓ tests/unit/utils/error-messages.test.ts (10 tests) 5ms
 ✓ tests/unit/tools/schemas/project-schemas.test.ts (8 tests) 4ms
 ✓ tests/unit/type-adapters.test.ts (13 tests) 7ms
 ✓ tests/unit/cache-manager.test.ts (28 tests) 5ms
 ❯ tests/unit/tools/tasks/query-tasks-smart-suggest.test.ts (3 tests | 1 failed) 11ms
   × QueryTasksToolV2 smart_suggest > scores and orders suggestions by overdue > today > flagged > quick wins and strips _score 9ms
     → expected [ 'Overdue', 'Flagged', 'Quick Win' ] to include 'Due Today'
   ✓ QueryTasksToolV2 smart_suggest > uses cache when available and skips execution 1ms
   ✓ QueryTasksToolV2 smart_suggest > returns SCRIPT_ERROR when underlying query fails 0ms
 ✓ tests/unit/tools/analytics/pattern-analysis-v2.test.ts (3 tests) 16ms
 ✓ tests/unit/tools/folders/folders-consolidated.test.ts (10 tests) 11ms
 ✓ tests/unit/tools/tasks/QueryTasksToolV2.test.ts (36 tests) 107ms
 ✓ tests/unit/tools/index-tools-registration.test.ts (1 test) 16ms
 ✓ tests/unit/omnifocus/scripts/bridge-template.test.ts (33 tests) 10ms
 ✓ tests/unit/omnifocus/scripts/script-builder.test.ts (23 tests) 3ms
 ✓ tests/unit/tools/tasks/manage-task-tool.test.ts (6 tests) 50ms
 ✓ tests/unit/omnifocus/plugins/core-recurring-analyzer.test.ts (5 tests) 6ms
 ✓ tests/unit/omnifocus/scripts/ScriptBuilder.test.ts (29 tests) 4ms
 ✓ tests/unit/utils/logger.test.ts (3 tests) 4ms
 ✓ tests/unit/utils/permissions.test.ts (6 tests) 4ms
 ✓ tests/unit/tools/export/export-tool.test.ts (5 tests) 5ms
 ✓ tests/unit/performance-optimizations.test.ts (15 tests) 8ms
 ✓ tests/unit/omnifocus/plugins/gaming-recurring-analyzer.test.ts (4 tests) 2ms
stdout | tests/unit/tag-conversion.test.ts > Tag Type Conversion Issues > should check for array/object conversion patterns in tag scripts
\nAnalyzing LIST_TAGS_SCRIPT for type conversion issues:
  Found 1 instances of pattern 5: \.map\(
\nAnalyzing MANAGE_TAGS_SCRIPT for type conversion issues:
  Found 2 instances of pattern 1: \.push\([^)]+\)(?!;)
  Found 1 instances of pattern 2: \.addTags\(\[
  Found 1 instances of pattern 3: \.removeTags\(\[
  Found 1 instances of pattern 5: \.map\(

stdout | tests/unit/tag-conversion.test.ts > Tag Type Conversion Issues > should identify complex object serialization
\nFound complex serialization patterns:
  LIST_TAGS: 27 instances
  MANAGE_TAGS: 26 instances
\nFound complex serialization patterns:
  LIST_TAGS: 1 instances

 ✓ tests/unit/tag-conversion.test.ts (3 tests) 6ms
 ✓ tests/unit/tag-operations.test.ts (4 tests) 4ms
 ✓ tests/unit/tools/export-bulk.test.ts (11 tests) 13ms
 ✓ tests/unit/task-search-limit.test.ts (3 tests) 2ms
 ✓ tests/unit/tools/list-tasks-tool.test.ts (7 tests) 9ms
 ✓ tests/unit/tools/reviews/manage-reviews.test.ts (6 tests) 28ms
 ✓ tests/unit/mcp-client.test.ts (2 tests) 4ms
 ↓ tests/unit/integration.test.ts (7 tests | 7 skipped)
 ↓ tests/unit/test-data-management.test.ts (6 tests | 6 skipped)

 Test Files  5 failed | 43 passed | 2 skipped (50)
      Tests  20 failed | 668 passed | 13 skipped (701)
   Start at  22:41:03
   Duration  2.39s (transform 1.89s, setup 2.21s, collect 4.44s, tests 1.05s, environment 7ms, prepare 2.97s)

